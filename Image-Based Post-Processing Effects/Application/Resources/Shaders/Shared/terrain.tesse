#version 450 core

layout(quads, fractional_even_spacing, cw) in;

in vec3 tcPosition[];
out vec2 vTexCoord;
out vec3 vWorldPos;

layout(binding = 1) uniform sampler2D uDisplacementTexture;

uniform mat4 uViewProjection;
uniform float uTexCoordScale = 1.0;
uniform float uDisplacementScale = 1.0;

// A very simple, regular procedural terrain for debugging cracks etc.
float debugSineHills(vec2 uv)
{
	const float HORIZ_SCALE = 4 * 3.14159, VERT_SCALE = 1;
	uv *= HORIZ_SCALE;
	return VERT_SCALE * (sin(uv.x) + 1) * (sin(uv.y) + 1) - 0.5;
}

void main()
{
    vec3 position = vec3(0.0f);

	float u = gl_TessCoord.x;
	float v = gl_TessCoord.y;
	
	vec3 a = mix(tcPosition[0], tcPosition[1], u);
	
	vec3 b = mix(tcPosition[3], tcPosition[2], u);
	
	position = mix(a, b, v);
	
	vTexCoord = position.xz * uTexCoordScale;
	
	vec3 displacement = texture(uDisplacementTexture, vTexCoord).xyz;
	
	position += displacement * uDisplacementScale;
	
	//position.y += debugSineHills(vTexCoord);
	
	vWorldPos = position;
	
    gl_Position = uViewProjection * vec4(position, 1.0);
}